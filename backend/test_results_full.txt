/Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend/.venv/lib/python3.13/site-packages/pytest_asyncio/plugin.py:252: PytestDeprecationWarning: The configuration option "asyncio_default_fixture_loop_scope" is unset.
The event loop scope for asynchronous fixtures will default to the fixture caching scope. Future versions of pytest-asyncio will default the loop scope for asynchronous fixtures to function scope. Set the default fixture loop scope explicitly in order to avoid unexpected behavior in the future. Valid fixture loop scopes are: "function", "class", "module", "package", "session"

  warnings.warn(PytestDeprecationWarning(_DEFAULT_FIXTURE_LOOP_SCOPE_UNSET))
============================= test session starts ==============================
platform darwin -- Python 3.13.5, pytest-8.3.5, pluggy-1.5.0 -- /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend
configfile: pytest.ini
plugins: asyncio-1.2.0, anyio-4.9.0, xdist-3.8.0, langsmith-0.3.21, mock-3.14.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 541 items

tests/e2e/test_complete_workflow_e2e.py::TestCompleteWorkflowE2E::test_complete_email_classification_flow_e2e SKIPPED [  0%]
tests/e2e/test_complete_workflow_e2e.py::TestCompleteWorkflowE2E::test_gmail_label_creation_and_application_e2e SKIPPED [  0%]
tests/e2e/test_gmail_real_api.py::TestGmailRealAPI::test_gmail_create_and_delete_label_e2e SKIPPED [  0%]
tests/e2e/test_gmail_real_api.py::TestGmailRealAPI::test_gmail_apply_label_to_message_e2e SKIPPED [  0%]
tests/e2e/test_gmail_real_api.py::TestGmailRealAPI::test_gmail_oauth_token_refresh_e2e SKIPPED [  0%]
tests/e2e/test_telegram_real_api.py::TestTelegramRealAPI::test_telegram_send_simple_message_e2e SKIPPED [  1%]
tests/e2e/test_telegram_real_api.py::TestTelegramRealAPI::test_telegram_send_message_with_buttons_e2e SKIPPED [  1%]
tests/e2e/test_telegram_real_api.py::TestTelegramRealAPI::test_telegram_edit_message_e2e SKIPPED [  1%]
tests/e2e/test_telegram_real_api.py::TestTelegramRealAPI::test_telegram_html_formatting_e2e SKIPPED [  1%]
tests/integration/test_approval_history_integration.py::test_approval_recording_in_workflow_approve PASSED [  1%]
tests/integration/test_approval_history_integration.py::test_approval_recording_in_workflow_reject PASSED [  2%]
tests/integration/test_approval_history_integration.py::test_approval_recording_in_workflow_change_folder PASSED [  2%]
tests/integration/test_approval_history_integration.py::test_statistics_api_endpoint PASSED [  2%]
tests/integration/test_approval_history_integration.py::test_database_index_performance PASSED [  2%]
tests/integration/test_approval_workflow_integration.py::TestApprovalWorkflowIntegration::test_complete_approve_workflow PASSED [  2%]
tests/integration/test_approval_workflow_integration.py::TestApprovalWorkflowIntegration::test_complete_reject_workflow PASSED [  2%]
tests/integration/test_approval_workflow_integration.py::TestApprovalWorkflowIntegration::test_complete_change_folder_workflow PASSED [  3%]
tests/integration/test_batch_notification_integration.py::test_complete_batch_notification_flow PASSED [  3%]
tests/integration/test_batch_notification_integration.py::test_priority_emails_bypass_batch PASSED [  3%]
tests/integration/test_batch_notification_integration.py::test_batch_with_no_pending_emails PASSED [  3%]
tests/integration/test_batch_notification_integration.py::test_celery_task_processes_all_users PASSED [  3%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_government_email_german PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_client_email_english PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_newsletter_email PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_unclear_email PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_russian_government_email PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_ukrainian_business_email PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_urgent_government_email_german PASSED [  5%]
tests/integration/test_classification_integration.py::TestEdgeCasesWithGeminiAPI::test_email_with_no_body PASSED [  5%]
tests/integration/test_classification_integration.py::TestEdgeCasesWithGeminiAPI::test_email_with_special_characters PASSED [  5%]
tests/integration/test_complete_system_e2e.py::TestCompleteSystemE2E::test_complete_email_to_response_workflow PASSED [  5%]
tests/integration/test_context_retrieval_integration.py::TestShortThreadAdaptiveK::test_retrieve_context_short_thread_adaptive_k PASSED [  5%]
tests/integration/test_context_retrieval_integration.py::TestStandardThreadHybridRAG::test_retrieve_context_standard_thread_hybrid_rag PASSED [  6%]
tests/integration/test_context_retrieval_integration.py::TestLongThreadSemanticSkip::test_retrieve_context_long_thread_skips_semantic PASSED [  6%]
tests/integration/test_context_retrieval_integration.py::TestTokenBudgetEnforcement::test_token_budget_enforcement_truncates_results PASSED [  6%]
tests/integration/test_context_retrieval_integration.py::TestPerformanceParallelRetrieval::test_retrieve_context_performance_parallel_retrieval PASSED [  6%]
tests/integration/test_email_polling_integration.py::test_email_polling_end_to_end PASSED [  6%]
tests/integration/test_email_polling_integration.py::test_email_polling_duplicate_detection PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_metadata_extraction PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_empty_inbox PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_mixed_new_and_duplicates PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_invalid_sender_email PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_workflow_integration PASSED [  7%]
tests/integration/test_email_workflow_integration.py::test_workflow_state_transitions PASSED [  8%]
tests/integration/test_email_workflow_integration.py::test_workflow_checkpoint_persistence PASSED [  8%]
tests/integration/test_email_workflow_integration.py::test_classification_result_stored_in_database PASSED [  8%]
tests/integration/test_email_workflow_integration.py::test_workflow_error_handling PASSED [  8%]
tests/integration/test_embedding_integration.py::TestEmbedAndStoreInChromaDB::test_embed_and_store_in_chromadb PASSED [  8%]
tests/integration/test_embedding_integration.py::TestBatchEmbeddingMultilingual::test_batch_embedding_multilingual_emails PASSED [  9%]
tests/integration/test_embedding_integration.py::TestBatchProcessingPerformance::test_batch_processing_performance_50_per_minute PASSED [  9%]
tests/integration/test_embedding_integration.py::TestIntegrationHelpers::test_vector_db_client_available PASSED [  9%]
tests/integration/test_embedding_integration.py::TestIntegrationHelpers::test_embedding_service_available PASSED [  9%]
tests/integration/test_epic_1_complete.py::test_epic_1_complete_workflow PASSED [  9%]
tests/integration/test_epic_2_workflow_integration.py::TestCompleteEmailWorkflow::test_complete_email_sorting_workflow PASSED [  9%]
tests/integration/test_epic_2_workflow_integration.py::TestRejectionAndFolderChange::test_email_rejection_workflow PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestRejectionAndFolderChange::test_folder_change_workflow PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestBatchNotificationSystem::test_batch_notification_workflow PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestBatchNotificationSystem::test_empty_batch_handling PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestPriorityEmailNotifications::test_priority_email_bypass_batch PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestPriorityEmailNotifications::test_priority_detection_government_domain PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestPriorityEmailNotifications::test_priority_detection_urgent_keywords PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestApprovalHistoryTracking::test_approval_history_rejection_recorded PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestApprovalHistoryTracking::test_approval_history_folder_change_recorded PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestApprovalHistoryTracking::test_approval_statistics_endpoint PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestPerformance::test_email_processing_latency_under_2_minutes PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestPerformance::test_workflow_resumption_latency_under_2_seconds PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestPerformance::test_batch_processing_performance_20_emails PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestErrorHandling::test_workflow_handles_gemini_api_failure PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestErrorHandling::test_workflow_handles_gmail_api_failure PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestErrorHandling::test_workflow_handles_telegram_api_failure PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestErrorHandling::test_workflow_checkpoint_recovery_after_crash PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration.py::TestWorkflowGraphStructure::test_workflow_has_generate_response_node PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration.py::TestWorkflowGraphStructure::test_workflow_conditional_routing_configured PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration.py::TestWorkflowGraphStructure::test_routing_logic_needs_response_path PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration.py::TestWorkflowGraphStructure::test_routing_logic_sort_only_path PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration_e2e.py::TestConditionalWorkflowRouting::test_needs_response_workflow_path PASSED [ 14%]
tests/integration/test_epic_3_workflow_integration_e2e.py::TestConditionalWorkflowRouting::test_sort_only_workflow_path PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestRetryUtilityIntegration::test_retry_with_eventual_success PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestRetryUtilityIntegration::test_retry_exhaustion_raises_exception PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestGmailAPIErrorHandling::test_gmail_apply_label_with_retry PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestTelegramAPIErrorHandling::test_telegram_send_message_with_retry PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestTelegramAPIErrorHandling::test_telegram_send_message_user_blocked_no_retry PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestTelegramAPIErrorHandling::test_telegram_message_truncation PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestWorkflowNodeErrorHandling::test_execute_action_gmail_error_updates_status PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestManualRetryCommand::test_retry_command_resets_error_status PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestErrorStatisticsEndpoint::test_error_statistics_calculation PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestEndToEndErrorRecovery::test_complete_error_recovery_flow PASSED [ 16%]
tests/integration/test_error_handling_integration.py::TestAdminErrorsEndpoint::test_admin_errors_endpoint_with_valid_key PASSED [ 16%]
tests/integration/test_error_handling_integration.py::TestAdminErrorsEndpoint::test_admin_errors_endpoint_with_filters PASSED [ 16%]
tests/integration/test_error_handling_integration.py::TestAdminErrorsEndpoint::test_admin_endpoint_invalid_api_key PASSED [ 16%]
tests/integration/test_error_handling_integration.py::TestUserStatsEndpoint::test_error_statistics_date_range_filter PASSED [ 16%]
tests/integration/test_gemini_integration.py::TestGeminiAPIRealCall::test_gemini_api_real_call PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiAPIRealCall::test_gemini_api_json_mode_real PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiTestEndpoint::test_test_endpoint_integration_text_mode PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiTestEndpoint::test_test_endpoint_integration_json_mode PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiTestEndpoint::test_test_endpoint_requires_authentication PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiTestEndpoint::test_test_endpoint_invalid_response_format PASSED [ 17%]
tests/integration/test_indexing_integration.py::test_indexing_progress_database_integration PASSED [ 18%]
tests/integration/test_indexing_integration.py::test_chromadb_embedding_storage_integration PASSED [ 18%]
tests/integration/test_indexing_integration.py::test_batch_processing_with_real_chromadb PASSED [ 18%]
tests/integration/test_indexing_integration.py::test_error_handling_with_database_rollback PASSED [ 18%]
tests/integration/test_indexing_integration.py::test_incremental_indexing_workflow PASSED [ 18%]
tests/integration/test_label_integration.py::test_label_creation_end_to_end PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_creation_duplicate_name PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_application_to_message PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_removal_from_message PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_list_all_labels PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_color_customization PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_unique_constraint_per_user PASSED [ 20%]
tests/integration/test_language_detection_integration.py::test_detect_all_4_supported_languages PASSED [ 20%]
tests/integration/test_language_detection_integration.py::test_store_detected_language_in_email_queue PASSED [ 20%]
tests/integration/test_language_detection_integration.py::test_mixed_language_email_workflow PASSED [ 20%]
tests/integration/test_language_detection_integration.py::test_low_confidence_fallback_to_english PASSED [ 20%]
tests/integration/test_multilingual_response_quality.py::test_russian_business_inquiry_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_ukrainian_client_request_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_english_business_proposal_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_german_government_email_formal_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_mixed_language_email_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_no_thread_history_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_unclear_tone_detection PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_short_email_language_detection PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_very_long_thread_response PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_rag_context_retrieval_performance PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_response_generation_end_to_end_performance PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_complete_email_to_telegram_to_send_workflow PASSED [ 23%]
tests/integration/test_oauth_integration.py::test_oauth_flow_end_to_end PASSED [ 23%]
tests/integration/test_oauth_integration.py::test_oauth_token_refresh_on_401 PASSED [ 23%]
tests/integration/test_oauth_integration.py::test_oauth_state_validation_csrf_protection PASSED [ 23%]
tests/integration/test_oauth_integration.py::test_oauth_existing_user_token_update PASSED [ 23%]
tests/integration/test_priority_detection_integration.py::test_priority_email_immediate_notification PASSED [ 24%]
tests/integration/test_priority_detection_integration.py::test_non_priority_email_batched PASSED [ 24%]
tests/integration/test_priority_detection_integration.py::test_priority_email_excluded_from_batch PASSED [ 24%]
tests/integration/test_priority_detection_integration.py::test_user_configured_priority_sender_integration PASSED [ 24%]
tests/integration/test_prompt_generation_integration.py::test_formal_german_government_email_prompt PASSED [ 24%]
tests/integration/test_prompt_generation_integration.py::test_professional_english_business_email_prompt PASSED [ 24%]
tests/integration/test_prompt_generation_integration.py::test_casual_russian_personal_email_prompt PASSED [ 25%]
tests/integration/test_prompt_generation_integration.py::test_multilingual_prompt_quality PASSED [ 25%]
tests/integration/test_prompt_generation_integration.py::test_tone_detection_with_real_gemini PASSED [ 25%]
tests/integration/test_response_draft_telegram_integration.py::test_end_to_end_response_draft_notification_german PASSED [ 25%]
tests/integration/test_response_draft_telegram_integration.py::test_end_to_end_response_draft_notification_english PASSED [ 25%]
tests/integration/test_response_draft_telegram_integration.py::test_response_draft_long_message_splitting PASSED [ 26%]
tests/integration/test_response_draft_telegram_integration.py::test_response_draft_notification_with_rag_context PASSED [ 26%]
tests/integration/test_response_draft_telegram_integration.py::test_response_draft_notification_priority_email PASSED [ 26%]
tests/integration/test_response_draft_telegram_integration.py::test_telegram_user_not_linked_handling PASSED [ 26%]
tests/integration/test_response_editing_sending_integration.py::test_end_to_end_edit_workflow PASSED [ 26%]
tests/integration/test_response_editing_sending_integration.py::test_end_to_end_send_original_draft PASSED [ 26%]
tests/integration/test_response_editing_sending_integration.py::test_end_to_end_send_edited_draft PASSED [ 27%]
tests/integration/test_response_editing_sending_integration.py::test_email_threading_in_reply PASSED [ 27%]
tests/integration/test_response_editing_sending_integration.py::test_sent_response_indexed_to_chromadb PASSED [ 27%]
tests/integration/test_response_editing_sending_integration.py::test_reject_response_workflow PASSED [ 27%]
tests/integration/test_response_generation_integration.py::test_end_to_end_response_generation_german_formal PASSED [ 27%]
tests/integration/test_response_generation_integration.py::test_end_to_end_response_generation_english_professional PASSED [ 28%]
tests/integration/test_response_generation_integration.py::test_should_not_generate_response_newsletter PASSED [ 28%]
tests/integration/test_response_generation_integration.py::test_response_quality_validation_rejects_invalid PASSED [ 28%]
tests/integration/test_response_generation_integration.py::test_response_generation_with_short_thread PASSED [ 28%]
tests/integration/test_response_generation_integration.py::test_response_generation_with_real_gemini SKIPPED [ 28%]
tests/integration/test_telegram_bot_integration.py::TestBotStartupAndPolling::test_bot_startup_and_polling PASSED [ 29%]
tests/integration/test_telegram_bot_integration.py::TestTelegramTestEndpoint::test_send_test_message_endpoint_success PASSED [ 29%]
tests/integration/test_telegram_bot_integration.py::TestTelegramTestEndpoint::test_send_message_no_telegram_linked PASSED [ 29%]
tests/integration/test_telegram_bot_integration.py::TestTelegramTestEndpoint::test_send_message_user_blocked_bot PASSED [ 29%]
tests/integration/test_telegram_linking_integration.py::TestGenerateCodeEndpoint::test_generate_code_endpoint_success PASSED [ 29%]
tests/integration/test_telegram_linking_integration.py::TestGenerateCodeEndpoint::test_generate_code_already_linked PASSED [ 29%]
tests/integration/test_telegram_linking_integration.py::TestTelegramStatusEndpoint::test_telegram_status_not_linked PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestTelegramStatusEndpoint::test_telegram_status_linked PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_with_valid_code PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_with_expired_code PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_with_used_code PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_with_invalid_code PASSED [ 31%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_without_code PASSED [ 31%]
tests/integration/test_vector_db_integration.py::test_vector_db_persistence_survives_restart PASSED [ 31%]
tests/integration/test_vector_db_integration.py::test_semantic_search_returns_similar_embeddings PASSED [ 31%]
tests/integration/test_vector_db_integration.py::test_query_performance_k10_under_500ms PASSED [ 31%]
tests/integration/test_vector_db_integration.py::test_connection_test_endpoint PASSED [ 31%]
tests/test_approval_history.py::test_approval_history_model_creation PASSED [ 32%]
tests/test_approval_history.py::test_record_approve_decision PASSED      [ 32%]
tests/test_approval_history.py::test_record_reject_decision PASSED       [ 32%]
tests/test_approval_history.py::test_record_change_folder_decision PASSED [ 32%]
tests/test_approval_history.py::test_get_user_history_with_filters PASSED [ 32%]
tests/test_approval_history.py::test_get_approval_statistics_calculation PASSED [ 33%]
tests/test_batch_notification_service.py::test_get_pending_emails_filters_correctly PASSED [ 33%]
tests/test_batch_notification_service.py::test_create_summary_message_format PASSED [ 33%]
tests/test_batch_notification_service.py::test_empty_batch_handling PASSED [ 33%]
tests/test_batch_notification_service.py::test_quiet_hours_check PASSED  [ 33%]
tests/test_batch_notification_service.py::test_batch_disabled_user PASSED [ 34%]
tests/test_batch_notification_service.py::test_individual_proposals_rate_limiting PASSED [ 34%]
tests/test_batch_notification_service.py::test_get_user_preferences_creates_defaults PASSED [ 34%]
tests/test_classification_prompt.py::TestPromptConstruction::test_build_classification_prompt_structure PASSED [ 34%]
tests/test_classification_prompt.py::TestPromptConstruction::test_build_classification_prompt_with_html_body PASSED [ 34%]
tests/test_classification_prompt.py::TestPromptConstruction::test_build_classification_prompt_with_long_body PASSED [ 34%]
tests/test_classification_prompt.py::TestPromptConstruction::test_preprocess_email_body_html_stripping PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_preprocess_email_body_truncation PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_preprocess_email_body_empty PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_format_folder_categories_multiple PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_format_folder_categories_empty PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_build_classification_prompt_with_multiple_folder_categories PASSED [ 36%]
tests/test_classification_prompt.py::TestPromptConstruction::test_prompt_version_constant PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_valid_full PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_valid_required_only PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_missing_required_field PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_invalid_priority_score PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_invalid_confidence PASSED [ 37%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_reasoning_too_long PASSED [ 37%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_empty_folder PASSED [ 37%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_to_dict PASSED [ 37%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_edge_values PASSED [ 37%]
tests/test_classification_service.py::test_classify_email_success PASSED [ 38%]
tests/test_classification_service.py::test_classify_email_gemini_api_error PASSED [ 38%]
tests/test_classification_service.py::test_classify_email_invalid_json_response PASSED [ 38%]
tests/test_classification_service.py::test_classify_email_gmail_retrieval_failure PASSED [ 38%]
tests/test_context_retrieval.py::TestThreadHistoryRetrieval::test_get_thread_history_returns_last_5_emails PASSED [ 38%]
tests/test_context_retrieval.py::TestSemanticSearch::test_get_semantic_results_queries_vector_db PASSED [ 39%]
tests/test_context_retrieval.py::TestAdaptiveKLogic::test_calculate_adaptive_k_logic PASSED [ 39%]
tests/test_context_retrieval.py::TestResultRanking::test_rank_semantic_results_by_score_and_recency PASSED [ 39%]
tests/test_context_retrieval.py::TestTokenCounting::test_count_tokens_uses_tiktoken PASSED [ 39%]
tests/test_context_retrieval.py::TestTokenBudgetEnforcement::test_enforce_token_budget_truncates_correctly PASSED [ 39%]
tests/test_context_retrieval.py::TestContextRetrievalOrchestration::test_retrieve_context_combines_thread_and_semantic PASSED [ 39%]
tests/test_context_retrieval.py::TestPerformance::test_retrieve_context_performance_under_3_seconds PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_start_indexing_creates_progress_record PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_retrieve_gmail_emails_90_day_filter PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_process_batch_embeds_and_stores_50_emails PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_extract_metadata_includes_all_fields PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_resume_indexing_from_checkpoint PASSED [ 41%]
tests/test_email_indexing.py::TestEmailIndexingService::test_handle_error_updates_progress_status PASSED [ 41%]
tests/test_email_indexing.py::TestEmailIndexingService::test_mark_complete_updates_status PASSED [ 41%]
tests/test_email_indexing.py::TestEmailIndexingService::test_incremental_indexing_new_email PASSED [ 41%]
tests/test_email_integration.py::test_send_email_end_to_end PASSED       [ 41%]
tests/test_email_integration.py::test_send_email_with_thread_reply PASSED [ 41%]
tests/test_email_integration.py::test_send_email_html_body PASSED        [ 42%]
tests/test_email_integration.py::test_send_email_invalid_recipient PASSED [ 42%]
tests/test_email_integration.py::test_send_email_quota_exceeded PASSED   [ 42%]
tests/test_email_integration.py::test_send_email_message_too_large PASSED [ 42%]
tests/test_email_integration.py::test_send_email_invalid_body_type PASSED [ 42%]
tests/test_email_integration.py::test_send_email_unauthenticated PASSED  [ 43%]
tests/test_email_integration.py::test_send_email_logging PASSED          [ 43%]
tests/test_email_model.py::test_email_model_creation PASSED              [ 43%]
tests/test_email_model.py::test_email_user_relationship PASSED           [ 43%]
tests/test_email_model.py::test_unique_gmail_message_id PASSED           [ 43%]
tests/test_email_model.py::test_status_field_values PASSED               [ 43%]
tests/test_email_model.py::test_cascade_delete_emails PASSED             [ 44%]
tests/test_email_model.py::test_email_timestamps PASSED                  [ 44%]
tests/test_email_model.py::test_default_status_pending PASSED            [ 44%]
tests/test_email_polling.py::test_poll_user_emails_fetches_unread_emails PASSED [ 44%]
tests/test_email_polling.py::test_duplicate_detection_skips_existing_emails PASSED [ 44%]
tests/test_email_polling.py::test_poll_all_users_iterates_active_users PASSED [ 45%]
tests/test_email_polling.py::test_poll_all_users_skips_users_without_token PASSED [ 45%]
tests/test_email_polling.py::test_polling_error_handling_transient_errors PASSED [ 45%]
tests/test_email_polling.py::test_polling_error_handling_permanent_errors PASSED [ 45%]
tests/test_email_polling.py::test_get_active_users_filters_active PASSED [ 45%]
tests/test_email_polling.py::test_email_metadata_extraction PASSED       [ 46%]
tests/test_email_polling.py::test_polling_cycle_logging PASSED           [ 46%]
tests/test_email_polling.py::test_poll_user_emails_handles_empty_inbox PASSED [ 46%]
tests/test_email_polling.py::test_poll_user_emails_skips_invalid_email PASSED [ 46%]
tests/test_email_polling.py::test_poll_saves_new_emails_to_database PASSED [ 46%]
tests/test_email_polling.py::test_duplicate_detection_with_database_persistence PASSED [ 46%]
tests/test_email_polling.py::test_poll_mixed_new_and_duplicate_emails_db PASSED [ 47%]
tests/test_email_sending.py::test_compose_mime_message_plain_text PASSED [ 47%]
tests/test_email_sending.py::test_compose_mime_message_html PASSED       [ 47%]
tests/test_email_sending.py::test_compose_mime_message_with_threading PASSED [ 47%]
tests/test_email_sending.py::test_compose_mime_message_invalid_body_type PASSED [ 47%]
tests/test_email_sending.py::test_send_email_success PASSED              [ 48%]
tests/test_email_sending.py::test_send_email_invalid_recipient PASSED    [ 48%]
tests/test_email_sending.py::test_send_email_quota_exceeded PASSED       [ 48%]
tests/test_email_sending.py::test_send_email_message_too_large PASSED    [ 48%]
tests/test_email_sending.py::test_get_thread_message_ids PASSED          [ 48%]
tests/test_email_sending.py::test_get_thread_message_ids_empty_thread_id PASSED [ 48%]
tests/test_email_sending.py::test_send_email_with_thread_id PASSED       [ 49%]
tests/test_email_sending.py::test_send_email_retry_on_network_error PASSED [ 49%]
tests/test_email_sending.py::test_send_email_logging PASSED              [ 49%]
tests/test_email_service.py::test_get_emails_by_status PASSED            [ 49%]
tests/test_email_service.py::test_get_pending_emails PASSED              [ 49%]
tests/test_email_service.py::test_get_email_by_message_id PASSED         [ 50%]
tests/test_email_service.py::test_update_email_status PASSED             [ 50%]
tests/test_email_service.py::test_update_email_status_not_found PASSED   [ 50%]
tests/test_email_service.py::test_get_emails_by_nonexistent_user PASSED  [ 50%]
tests/test_email_service.py::test_get_emails_by_status_multiple_statuses PASSED [ 50%]
tests/test_email_service.py::test_get_emails_filters_by_user PASSED      [ 51%]
tests/test_embedding_service.py::TestEmbeddingServiceInitialization::test_embedding_service_initialization PASSED [ 51%]
tests/test_embedding_service.py::TestEmbeddingServiceInitialization::test_embedding_service_explicit_api_key PASSED [ 51%]
tests/test_embedding_service.py::TestEmbeddingServiceInitialization::test_embedding_service_missing_api_key PASSED [ 51%]
tests/test_embedding_service.py::TestEmbeddingServiceInitialization::test_embedding_service_custom_model PASSED [ 51%]
tests/test_embedding_service.py::TestEmbedText::test_embed_text_returns_768_dimensions PASSED [ 51%]
tests/test_embedding_service.py::TestEmbedText::test_embed_text_preprocesses_input PASSED [ 52%]
tests/test_embedding_service.py::TestEmbedText::test_embed_text_raises_on_empty_input PASSED [ 52%]
tests/test_embedding_service.py::TestEmbedBatch::test_embed_batch_processes_multiple_texts PASSED [ 52%]
tests/test_embedding_service.py::TestEmbedBatch::test_embed_batch_respects_batch_size_limit PASSED [ 52%]
tests/test_embedding_service.py::TestEmbedBatch::test_embed_batch_raises_on_empty_list PASSED [ 52%]
tests/test_embedding_service.py::TestErrorHandling::test_embedding_service_handles_api_errors PASSED [ 53%]
tests/test_embedding_service.py::TestErrorHandling::test_retry_logic_with_exponential_backoff PASSED [ 53%]
tests/test_embedding_service.py::TestValidateDimensions::test_validate_dimensions_detects_invalid_output PASSED [ 53%]
tests/test_embedding_service.py::TestAPIUsageLogging::test_api_usage_logging_records_requests PASSED [ 53%]
tests/test_embedding_service.py::TestAPIUsageLogging::test_get_usage_stats_returns_correct_format PASSED [ 53%]
tests/test_embedding_service.py::TestEmbeddingServiceIntegration::test_complete_embedding_workflow PASSED [ 53%]
tests/test_encryption.py::test_encrypt_decrypt_roundtrip PASSED          [ 54%]
tests/test_encryption.py::test_encrypt_different_tokens_produce_different_ciphertexts PASSED [ 54%]
tests/test_encryption.py::test_decrypt_invalid_ciphertext_raises_exception PASSED [ 54%]
tests/test_encryption.py::test_encrypt_empty_string PASSED               [ 54%]
tests/test_encryption.py::test_encrypt_long_token PASSED                 [ 54%]
tests/test_encryption.py::test_encrypt_token_with_special_characters PASSED [ 55%]
tests/test_folder_category_model.py::test_folder_category_creation PASSED [ 55%]
tests/test_folder_category_model.py::test_user_folder_relationship PASSED [ 55%]
tests/test_folder_category_model.py::test_unique_constraint_user_folder_name PASSED [ 55%]
tests/test_folder_category_model.py::test_cascade_delete_folders PASSED  [ 55%]
tests/test_folder_category_model.py::test_folder_keywords_array PASSED   [ 56%]
tests/test_folder_service.py::test_create_folder_end_to_end PASSED       [ 56%]
tests/test_folder_service.py::test_list_folders_by_user PASSED           [ 56%]
tests/test_folder_service.py::test_get_folder_by_id PASSED               [ 56%]
tests/test_folder_service.py::test_delete_folder PASSED                  [ 56%]
tests/test_folder_service.py::test_duplicate_folder_name_error PASSED    [ 56%]
tests/test_folder_service.py::test_create_folder_invalid_name PASSED     [ 57%]
tests/test_folder_service.py::test_create_folder_with_keywords_and_color PASSED [ 57%]
tests/test_folder_service.py::test_user_isolation PASSED                 [ 57%]
tests/test_gmail_client.py::test_gmail_client_initialization PASSED      [ 57%]
tests/test_gmail_client.py::test_get_gmail_service_builds_service PASSED [ 57%]
tests/test_gmail_client.py::test_parse_gmail_date_converts_milliseconds PASSED [ 58%]
tests/test_gmail_client.py::test_parse_gmail_date_handles_none PASSED    [ 58%]
tests/test_gmail_client.py::test_decode_base64url PASSED                 [ 58%]
tests/test_gmail_client.py::test_decode_base64url_handles_empty_string PASSED [ 58%]
tests/test_gmail_client.py::test_html_stripper_removes_tags PASSED       [ 58%]
tests/test_gmail_client.py::test_strip_html PASSED                       [ 58%]
tests/test_gmail_client.py::test_extract_body_simple_message PASSED      [ 59%]
tests/test_gmail_client.py::test_extract_body_text_plain_multipart PASSED [ 59%]
tests/test_gmail_client.py::test_extract_body_html_fallback PASSED       [ 59%]
tests/test_gmail_client.py::test_extract_body_empty_payload PASSED       [ 59%]
tests/test_gmail_client.py::test_get_messages_returns_email_list PASSED  [ 59%]
tests/test_gmail_client.py::test_get_message_detail_returns_full_content PASSED [ 60%]
tests/test_gmail_client.py::test_get_message_detail_extracts_html_body PASSED [ 60%]
tests/test_gmail_client.py::test_get_message_detail_handles_multipart PASSED [ 60%]
tests/test_gmail_client.py::test_get_thread_returns_sorted_messages PASSED [ 60%]
tests/test_gmail_client.py::test_token_refresh_on_401_error PASSED       [ 60%]
tests/test_gmail_client.py::test_rate_limit_exponential_backoff PASSED   [ 60%]
tests/test_gmail_client.py::test_server_error_retry PASSED               [ 61%]
tests/test_gmail_client.py::test_non_retryable_error_raises PASSED       [ 61%]
tests/test_gmail_client.py::test_extract_body_deeply_nested_multipart PASSED [ 61%]
tests/test_gmail_label_management.py::test_list_labels_success PASSED    [ 61%]
tests/test_gmail_label_management.py::test_create_label_with_color PASSED [ 61%]
tests/test_gmail_label_management.py::test_create_label_duplicate_returns_existing PASSED [ 62%]
tests/test_gmail_label_management.py::test_apply_label_to_message PASSED [ 62%]
tests/test_gmail_label_management.py::test_remove_label_from_message PASSED [ 62%]
tests/test_gmail_label_management.py::test_apply_label_not_found PASSED  [ 62%]
tests/test_gmail_label_management.py::test_label_color_configuration PASSED [ 62%]
tests/test_indexing_tasks.py::TestIndexingTasks::test_index_user_emails_task_calls_service PASSED [ 63%]
tests/test_indexing_tasks.py::TestIndexingTasks::test_task_handles_service_exceptions PASSED [ 63%]
tests/test_indexing_tasks.py::TestIndexingTasks::test_task_respects_timeout_configuration PASSED [ 63%]
tests/test_indexing_tasks.py::TestIndexingTasks::test_resume_user_indexing_task PASSED [ 63%]
tests/test_indexing_tasks.py::TestIndexingTasks::test_index_new_email_background_task PASSED [ 63%]
tests/test_language_detection.py::test_detect_returns_language_and_confidence PASSED [ 63%]
tests/test_language_detection.py::test_supported_languages_validation PASSED [ 64%]
tests/test_language_detection.py::test_mixed_language_returns_primary PASSED [ 64%]
tests/test_language_detection.py::test_confidence_threshold_fallback PASSED [ 64%]
tests/test_language_detection.py::test_edge_cases_empty_and_short_text PASSED [ 64%]
tests/test_language_detection.py::test_error_handling_invalid_input PASSED [ 64%]
tests/test_language_detection.py::test_detect_primary_language_single_language PASSED [ 65%]
tests/test_language_detection.py::test_supported_languages_constant PASSED [ 65%]
tests/test_language_detection.py::test_confidence_threshold_constant PASSED [ 65%]
tests/test_llm_client.py::TestLLMClientInitialization::test_initialization_with_env_vars PASSED [ 65%]
tests/test_llm_client.py::TestLLMClientInitialization::test_initialization_with_explicit_params PASSED [ 65%]
tests/test_llm_client.py::TestLLMClientInitialization::test_initialization_without_api_key PASSED [ 65%]
tests/test_llm_client.py::TestLLMClientInitialization::test_token_usage_counters_initialized PASSED [ 66%]
tests/test_llm_client.py::TestSendPrompt::test_send_prompt_success_text_mode PASSED [ 66%]
tests/test_llm_client.py::TestSendPrompt::test_send_prompt_json_mode PASSED [ 66%]
tests/test_llm_client.py::TestSendPrompt::test_receive_completion_wrapper PASSED [ 66%]
tests/test_llm_client.py::TestSendPrompt::test_send_prompt_with_operation_label PASSED [ 66%]
tests/test_llm_client.py::TestErrorHandling::test_rate_limit_error_429 PASSED [ 67%]
tests/test_llm_client.py::TestErrorHandling::test_timeout_error PASSED   [ 67%]
tests/test_llm_client.py::TestErrorHandling::test_blocked_prompt_error_no_retry PASSED [ 67%]
tests/test_llm_client.py::TestErrorHandling::test_invalid_api_key_error PASSED [ 67%]
tests/test_llm_client.py::TestErrorHandling::test_stop_candidate_exception PASSED [ 67%]
tests/test_llm_client.py::TestErrorHandling::test_generic_api_error PASSED [ 68%]
tests/test_llm_client.py::TestTokenUsageTracking::test_token_usage_extracted_from_response PASSED [ 68%]
tests/test_llm_client.py::TestTokenUsageTracking::test_token_usage_cumulative PASSED [ 68%]
tests/test_llm_client.py::TestTokenUsageTracking::test_prometheus_metric_incremented PASSED [ 68%]
tests/test_llm_client.py::TestTokenUsageTracking::test_no_usage_metadata_warning PASSED [ 68%]
tests/test_llm_client.py::TestJSONParsing::test_receive_completion_parse_error PASSED [ 68%]
tests/test_llm_client.py::TestRetryLogic::test_retry_on_rate_limit_then_success PASSED [ 69%]
tests/test_llm_client.py::TestRetryLogic::test_retry_exhausted_after_3_attempts PASSED [ 69%]
tests/test_llm_client.py::TestRetryLogic::test_no_retry_on_permanent_error PASSED [ 69%]
tests/test_migration_2_3_schema.py::test_story_2_3_migration_columns_exist SKIPPED [ 69%]
tests/test_migration_2_3_schema.py::test_story_2_3_foreign_key_constraint_exists SKIPPED [ 69%]
tests/test_migration_2_3_schema.py::test_story_2_3_migration_default_values SKIPPED [ 70%]
tests/test_preprocessing.py::TestStripHTML::test_strip_html_removes_tags PASSED [ 70%]
tests/test_preprocessing.py::TestStripHTML::test_strip_html_handles_encoding_issues PASSED [ 70%]
tests/test_preprocessing.py::TestStripHTML::test_strip_html_raises_on_none PASSED [ 70%]
tests/test_preprocessing.py::TestExtractEmailText::test_extract_email_text_handles_plain_and_html PASSED [ 70%]
tests/test_preprocessing.py::TestExtractEmailText::test_extract_email_text_handles_whitespace PASSED [ 70%]
tests/test_preprocessing.py::TestExtractEmailText::test_extract_email_text_raises_on_none PASSED [ 71%]
tests/test_preprocessing.py::TestTruncateToTokens::test_truncate_to_tokens_respects_limit PASSED [ 71%]
tests/test_preprocessing.py::TestTruncateToTokens::test_truncate_to_tokens_handles_edge_cases PASSED [ 71%]
tests/test_preprocessing.py::TestTruncateToTokens::test_truncate_to_tokens_raises_on_invalid_input PASSED [ 71%]
tests/test_preprocessing.py::TestPreprocessingIntegration::test_complete_html_email_pipeline PASSED [ 71%]
tests/test_preprocessing.py::TestPreprocessingIntegration::test_complete_plain_email_pipeline PASSED [ 72%]
tests/test_priority_detection.py::test_government_domain_detection PASSED [ 72%]
tests/test_priority_detection.py::test_urgency_keyword_detection_german PASSED [ 72%]
tests/test_priority_detection.py::test_urgency_keyword_detection_multilingual PASSED [ 72%]
tests/test_priority_detection.py::test_priority_threshold_triggering PASSED [ 72%]
tests/test_priority_detection.py::test_user_configured_priority_sender PASSED [ 73%]
tests/test_priority_detection.py::test_priority_score_capped_at_100 PASSED [ 73%]
tests/test_priority_detection.py::test_priority_detection_logging PASSED [ 73%]
tests/test_priority_detection.py::test_extract_domain_from_email_formats PASSED [ 73%]
tests/test_response_editing_sending.py::test_handle_edit_response_callback PASSED [ 73%]
tests/test_response_editing_sending.py::test_handle_message_reply_edited_text PASSED [ 73%]
tests/test_response_editing_sending.py::test_handle_send_response_original_draft PASSED [ 74%]
tests/test_response_editing_sending.py::test_handle_send_response_edited_draft PASSED [ 74%]
tests/test_response_editing_sending.py::test_gmail_send_with_threading PASSED [ 74%]
tests/test_response_editing_sending.py::test_telegram_confirmation_message PASSED [ 74%]
tests/test_response_editing_sending.py::test_email_status_updated_completed PASSED [ 74%]
tests/test_response_editing_sending.py::test_index_sent_response_to_vector_db PASSED [ 75%]
tests/test_response_editing_sending.py::test_handle_reject_response_callback PASSED [ 75%]
tests/test_response_editing_sending.py::test_error_handling_invalid_email_id PASSED [ 75%]
tests/test_response_generation.py::test_should_generate_response_personal_email PASSED [ 75%]
tests/test_response_generation.py::test_should_generate_response_newsletter PASSED [ 75%]
tests/test_response_generation.py::test_should_generate_response_noreply_email PASSED [ 75%]
tests/test_response_generation.py::test_generate_response_with_rag_context PASSED [ 76%]
tests/test_response_generation.py::test_generate_response_language_detection PASSED [ 76%]
tests/test_response_generation.py::test_generate_response_tone_detection PASSED [ 76%]
tests/test_response_generation.py::test_generate_response_prompt_formatting PASSED [ 76%]
tests/test_response_generation.py::test_validate_response_success PASSED [ 76%]
tests/test_response_generation.py::test_validate_response_failures PASSED [ 77%]
tests/test_response_generation.py::test_save_response_draft_database PASSED [ 77%]
tests/test_response_generation_prompts.py::test_tone_detection_government_domains PASSED [ 77%]
tests/test_response_generation_prompts.py::test_tone_detection_business_clients PASSED [ 77%]
tests/test_response_generation_prompts.py::test_tone_detection_personal_contacts PASSED [ 77%]
tests/test_response_generation_prompts.py::test_prompt_template_formatting PASSED [ 78%]
tests/test_response_generation_prompts.py::test_greeting_closing_selection PASSED [ 78%]
tests/test_response_generation_prompts.py::test_prompt_length_constraints PASSED [ 78%]
tests/test_response_generation_prompts.py::test_prompt_multilingual_support PASSED [ 78%]
tests/test_response_generation_prompts.py::test_prompt_version_storage PASSED [ 78%]
tests/test_response_quality_evaluation.py::test_evaluate_language_accuracy_russian PASSED [ 78%]
tests/test_response_quality_evaluation.py::test_evaluate_language_accuracy_german PASSED [ 79%]
tests/test_response_quality_evaluation.py::test_evaluate_tone_appropriateness_formal_german PASSED [ 79%]
tests/test_response_quality_evaluation.py::test_evaluate_tone_appropriateness_casual_english PASSED [ 79%]
tests/test_response_quality_evaluation.py::test_evaluate_context_awareness_thread_reference PASSED [ 79%]
tests/test_response_quality_evaluation.py::test_evaluate_context_awareness_no_context PASSED [ 79%]
tests/test_response_quality_evaluation.py::test_response_quality_report_aggregation PASSED [ 80%]
tests/test_response_quality_evaluation.py::test_response_quality_acceptable_threshold PASSED [ 80%]
tests/test_retry_utility.py::TestRetryUtility::test_successful_execution_first_attempt PASSED [ 80%]
tests/test_retry_utility.py::TestRetryUtility::test_successful_execution_after_failures PASSED [ 80%]
tests/test_retry_utility.py::TestRetryUtility::test_all_retries_exhausted PASSED [ 80%]
tests/test_retry_utility.py::TestRetryUtility::test_exponential_backoff_calculation PASSED [ 80%]
tests/test_retry_utility.py::TestRetryUtility::test_exponential_backoff_max_cap PASSED [ 81%]
tests/test_retry_utility.py::TestRetryUtility::test_http_error_retry PASSED [ 81%]
tests/test_retry_utility.py::TestRetryUtility::test_multiple_exception_types PASSED [ 81%]
tests/test_retry_utility.py::TestRetryUtility::test_sync_function_wrapper PASSED [ 81%]
tests/test_telegram_bot.py::TestTelegramBotInitialization::test_telegram_bot_initialization PASSED [ 81%]
tests/test_telegram_bot.py::TestTelegramBotInitialization::test_telegram_bot_initialization_no_token PASSED [ 82%]
tests/test_telegram_bot.py::TestSendMessage::test_send_message_success PASSED [ 82%]
tests/test_telegram_bot.py::TestSendMessage::test_send_message_user_blocked PASSED [ 82%]
tests/test_telegram_bot.py::TestSendMessage::test_send_message_network_error PASSED [ 82%]
tests/test_telegram_bot.py::TestSendMessage::test_send_message_not_initialized PASSED [ 82%]
tests/test_telegram_bot.py::TestSendMessage::test_send_message_invalid_telegram_id PASSED [ 82%]
tests/test_telegram_bot.py::TestSendMessage::test_send_message_exceeds_length_limit PASSED [ 83%]
tests/test_telegram_bot.py::TestSendMessageWithButtons::test_send_message_with_buttons_success PASSED [ 83%]
tests/test_telegram_bot.py::TestCommandHandlers::test_start_command_handler PASSED [ 83%]
tests/test_telegram_bot.py::TestCommandHandlers::test_start_command_handler_with_code PASSED [ 83%]
tests/test_telegram_bot.py::TestCommandHandlers::test_help_command_handler PASSED [ 83%]
tests/test_telegram_bot.py::TestCommandHandlers::test_test_command_handler PASSED [ 84%]
tests/test_telegram_callbacks.py::TestCallbackDataParsing::test_approve_callback_format PASSED [ 84%]
tests/test_telegram_callbacks.py::TestCallbackDataParsing::test_reject_callback_format PASSED [ 84%]
tests/test_telegram_callbacks.py::TestCallbackDataParsing::test_change_folder_callback_format PASSED [ 84%]
tests/test_telegram_callbacks.py::TestCallbackDataParsing::test_folder_selection_callback_format PASSED [ 84%]
tests/test_telegram_callbacks.py::TestCallbackDataParsing::test_malformed_callback_data_too_short PASSED [ 85%]
tests/test_telegram_callbacks.py::TestCallbackDataParsing::test_malformed_callback_data_invalid_email_id PASSED [ 85%]
tests/test_telegram_callbacks.py::TestCallbackDataParsing::test_malformed_folder_callback_format PASSED [ 85%]
tests/test_telegram_callbacks.py::TestCallbackDataParsing::test_unknown_action PASSED [ 85%]
tests/test_telegram_callbacks.py::TestUserOwnershipValidation::test_valid_ownership PASSED [ 85%]
tests/test_telegram_callbacks.py::TestUserOwnershipValidation::test_user_not_found PASSED [ 85%]
tests/test_telegram_callbacks.py::TestUserOwnershipValidation::test_email_not_found PASSED [ 86%]
tests/test_telegram_callbacks.py::TestUserOwnershipValidation::test_ownership_mismatch PASSED [ 86%]
tests/test_telegram_callbacks.py::TestCallbackQueryHandler::test_callback_query_routing_to_approve PASSED [ 86%]
tests/test_telegram_callbacks.py::TestCallbackQueryHandler::test_callback_query_unauthorized PASSED [ 86%]
tests/test_telegram_callbacks.py::TestCallbackQueryHandler::test_callback_query_malformed_data PASSED [ 86%]
tests/test_telegram_linking.py::test_generate_linking_code PASSED        [ 87%]
tests/test_telegram_linking.py::test_linking_code_uniqueness PASSED      [ 87%]
tests/test_telegram_linking.py::test_link_telegram_account_success PASSED [ 87%]
tests/test_telegram_linking.py::test_link_telegram_account_invalid_code PASSED [ 87%]
tests/test_telegram_linking.py::test_link_telegram_account_expired_code PASSED [ 87%]
tests/test_telegram_linking.py::test_link_telegram_account_used_code PASSED [ 87%]
tests/test_telegram_linking.py::test_link_telegram_account_already_linked_to_another_user PASSED [ 88%]
tests/test_telegram_linking.py::test_link_telegram_account_case_insensitive PASSED [ 88%]
tests/test_telegram_message_formatter.py::TestFormatSortingProposalMessage::test_format_regular_email PASSED [ 88%]
tests/test_telegram_message_formatter.py::TestFormatSortingProposalMessage::test_format_priority_email PASSED [ 88%]
tests/test_telegram_message_formatter.py::TestFormatSortingProposalMessage::test_body_preview_truncation_at_100_chars PASSED [ 88%]
tests/test_telegram_message_formatter.py::TestFormatSortingProposalMessage::test_body_preview_no_truncation_under_100_chars PASSED [ 89%]
tests/test_telegram_message_formatter.py::TestFormatSortingProposalMessage::test_markdown_escaping_special_chars PASSED [ 89%]
tests/test_telegram_message_formatter.py::TestFormatSortingProposalMessage::test_empty_body_preview PASSED [ 89%]
tests/test_telegram_message_formatter.py::TestFormatSortingProposalMessage::test_message_structure PASSED [ 89%]
tests/test_telegram_message_formatter.py::TestCreateInlineKeyboard::test_keyboard_structure PASSED [ 89%]
tests/test_telegram_message_formatter.py::TestCreateInlineKeyboard::test_button_labels PASSED [ 90%]
tests/test_telegram_message_formatter.py::TestCreateInlineKeyboard::test_callback_data_format PASSED [ 90%]
tests/test_telegram_message_formatter.py::TestCreateInlineKeyboard::test_callback_data_with_different_email_ids PASSED [ 90%]
tests/test_telegram_message_formatter.py::TestCreateInlineKeyboard::test_button_types PASSED [ 90%]
tests/test_telegram_response_draft.py::test_format_response_draft_message_standard PASSED [ 90%]
tests/test_telegram_response_draft.py::test_format_response_draft_message_priority PASSED [ 90%]
tests/test_telegram_response_draft.py::test_format_response_draft_message_long_draft PASSED [ 91%]
tests/test_telegram_response_draft.py::test_format_response_draft_message_no_context PASSED [ 91%]
tests/test_telegram_response_draft.py::test_build_response_draft_keyboard PASSED [ 91%]
tests/test_telegram_response_draft.py::test_send_response_draft_to_telegram PASSED [ 91%]
tests/test_telegram_response_draft.py::test_save_telegram_message_mapping PASSED [ 91%]
tests/test_telegram_response_draft.py::test_send_draft_notification_orchestration PASSED [ 92%]
tests/test_telegram_response_draft.py::test_send_draft_notification_user_blocked PASSED [ 92%]
tests/test_telegram_response_draft.py::test_format_response_draft_message_email_not_found PASSED [ 92%]
tests/test_telegram_response_draft.py::test_format_response_draft_message_no_draft_response PASSED [ 92%]
tests/test_telegram_response_draft.py::test_format_response_draft_message_long_subject PASSED [ 92%]
tests/test_telegram_response_draft.py::test_send_response_draft_to_telegram_email_not_found PASSED [ 92%]
tests/test_telegram_response_draft.py::test_send_response_draft_to_telegram_user_not_found PASSED [ 93%]
tests/test_telegram_response_draft.py::test_send_response_draft_to_telegram_generic_exception PASSED [ 93%]
tests/test_telegram_response_draft.py::test_save_telegram_message_mapping_email_not_found PASSED [ 93%]
tests/test_telegram_response_draft.py::test_save_telegram_message_mapping_update_existing PASSED [ 93%]
tests/test_telegram_response_draft.py::test_send_draft_notification_email_not_found PASSED [ 93%]
tests/test_telegram_response_draft.py::test_send_draft_notification_no_draft_response PASSED [ 94%]
tests/test_users_api.py::TestCompleteOnboardingTasks::test_complete_onboarding_triggers_indexing PASSED [ 94%]
tests/test_users_api.py::TestCompleteOnboardingTasks::test_complete_onboarding_triggers_polling PASSED [ 94%]
tests/test_users_api.py::TestCompleteOnboardingTasks::test_complete_onboarding_succeeds_when_tasks_fail PASSED [ 94%]
tests/test_users_api.py::TestCompleteOnboardingTasks::test_complete_onboarding_logs_task_triggers PASSED [ 94%]
tests/test_users_api.py::TestCompleteOnboardingTasks::test_complete_onboarding_logs_warning_on_task_failure PASSED [ 95%]
tests/test_vector_db_client.py::test_vector_db_client_initialization PASSED [ 95%]
tests/test_vector_db_client.py::test_vector_db_client_initialization_invalid_directory PASSED [ 95%]
tests/test_vector_db_client.py::test_create_collection_with_cosine_similarity PASSED [ 95%]
tests/test_vector_db_client.py::test_create_collection_with_empty_name PASSED [ 95%]
tests/test_vector_db_client.py::test_insert_single_embedding PASSED      [ 95%]
tests/test_vector_db_client.py::test_insert_single_embedding_validation PASSED [ 96%]
tests/test_vector_db_client.py::test_insert_embeddings_batch PASSED      [ 96%]
tests/test_vector_db_client.py::test_insert_embeddings_batch_validation PASSED [ 96%]
tests/test_vector_db_client.py::test_query_embeddings_returns_k_results PASSED [ 96%]
tests/test_vector_db_client.py::test_query_embeddings_validation PASSED  [ 96%]
tests/test_vector_db_client.py::test_query_embeddings_filters_by_metadata PASSED [ 97%]
tests/test_vector_db_client.py::test_delete_embedding_by_id PASSED       [ 97%]
tests/test_vector_db_client.py::test_delete_embedding_validation PASSED  [ 97%]
tests/test_vector_db_client.py::test_health_check_returns_true_when_connected PASSED [ 97%]
tests/test_workflow_conditional_routing.py::TestRoutingLogic::test_route_by_classification_needs_response PASSED [ 97%]
tests/test_workflow_conditional_routing.py::TestRoutingLogic::test_route_by_classification_sort_only PASSED [ 97%]
tests/test_workflow_conditional_routing.py::TestNodeLogic::test_classify_sets_classification_needs_response PASSED [ 98%]
tests/test_workflow_conditional_routing.py::TestNodeLogic::test_draft_response_calls_service PASSED [ 98%]
tests/test_workflow_conditional_routing.py::TestNodeLogic::test_send_telegram_uses_correct_template PASSED [ 98%]
tests/test_workflow_mapping.py::TestWorkflowMappingModel::test_create_workflow_mapping PASSED [ 98%]
tests/test_workflow_mapping.py::TestWorkflowMappingModel::test_unique_constraint_on_email_id PASSED [ 98%]
tests/test_workflow_mapping.py::TestWorkflowMappingModel::test_unique_constraint_on_thread_id PASSED [ 99%]
tests/test_workflow_mapping.py::TestWorkflowMappingModel::test_update_telegram_message_id PASSED [ 99%]
tests/test_workflow_mapping.py::TestWorkflowMappingModel::test_cascade_delete_on_email_delete PASSED [ 99%]
tests/test_workflow_mapping.py::TestWorkflowMappingModel::test_cascade_delete_on_user_delete PASSED [ 99%]
tests/test_workflow_mapping.py::TestWorkflowMappingModel::test_lookup_by_thread_id PASSED [ 99%]
tests/test_workflow_mapping.py::TestWorkflowMappingModel::test_workflow_state_transitions PASSED [100%]

=============================== warnings summary ===============================
.venv/lib/python3.13/site-packages/pydantic/v1/typing.py:68
.venv/lib/python3.13/site-packages/pydantic/v1/typing.py:68
.venv/lib/python3.13/site-packages/pydantic/v1/typing.py:68
.venv/lib/python3.13/site-packages/pydantic/v1/typing.py:68
.venv/lib/python3.13/site-packages/pydantic/v1/typing.py:68
.venv/lib/python3.13/site-packages/pydantic/v1/typing.py:68
.venv/lib/python3.13/site-packages/pydantic/v1/typing.py:68
  /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend/.venv/lib/python3.13/site-packages/pydantic/v1/typing.py:68: DeprecationWarning: Failing to pass a value to the 'type_params' parameter of 'typing.ForwardRef._evaluate' is deprecated, as it leads to incorrect behaviour when calling typing.ForwardRef._evaluate on a stringified annotation that references a PEP 695 type parameter. It will be disallowed in Python 3.15.
    return cast(Any, type_)._evaluate(globalns, localns, recursive_guard=set())

.venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:323
  /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend/.venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

.venv/lib/python3.13/site-packages/pydantic/fields.py:1076: 15 warnings
  /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend/.venv/lib/python3.13/site-packages/pydantic/fields.py:1076: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warn(

tests/test_email_indexing.py::TestEmailIndexingService::test_start_indexing_creates_progress_record
  /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend/app/services/email_indexing.py:200: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    session.add(progress)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_email_integration.py::test_send_email_with_thread_reply
  /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend/.venv/lib/python3.13/site-packages/psycopg/pq/pq_ctypes.py:619: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    rv: int = impl.PQflush(self._pgconn_ptr)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_email_polling.py::test_poll_all_users_skips_users_without_token
tests/test_email_polling.py::test_polling_error_handling_transient_errors
  /opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:2247: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __init__(self, name, parent):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_email_polling.py::test_poll_user_emails_handles_empty_inbox
  /opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py:2060: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def get_debug(self):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========== 528 passed, 13 skipped, 32 warnings in 317.24s (0:05:17) ===========
