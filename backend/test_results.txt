============================= test session starts ==============================
platform darwin -- Python 3.13.5, pytest-8.3.5, pluggy-1.5.0 -- /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/hdv_1987/Desktop/Прроекты/Mail Agent/backend
configfile: pyproject.toml
plugins: asyncio-1.2.0, anyio-4.9.0, xdist-3.8.0, langsmith-0.3.21, mock-3.14.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collecting ... collected 541 items

tests/e2e/test_complete_workflow_e2e.py::TestCompleteWorkflowE2E::test_complete_email_classification_flow_e2e SKIPPED [  0%]
tests/e2e/test_complete_workflow_e2e.py::TestCompleteWorkflowE2E::test_gmail_label_creation_and_application_e2e SKIPPED [  0%]
tests/e2e/test_gmail_real_api.py::TestGmailRealAPI::test_gmail_create_and_delete_label_e2e SKIPPED [  0%]
tests/e2e/test_gmail_real_api.py::TestGmailRealAPI::test_gmail_apply_label_to_message_e2e SKIPPED [  0%]
tests/e2e/test_gmail_real_api.py::TestGmailRealAPI::test_gmail_oauth_token_refresh_e2e SKIPPED [  0%]
tests/e2e/test_telegram_real_api.py::TestTelegramRealAPI::test_telegram_send_simple_message_e2e SKIPPED [  1%]
tests/e2e/test_telegram_real_api.py::TestTelegramRealAPI::test_telegram_send_message_with_buttons_e2e SKIPPED [  1%]
tests/e2e/test_telegram_real_api.py::TestTelegramRealAPI::test_telegram_edit_message_e2e SKIPPED [  1%]
tests/e2e/test_telegram_real_api.py::TestTelegramRealAPI::test_telegram_html_formatting_e2e SKIPPED [  1%]
tests/integration/test_approval_history_integration.py::test_approval_recording_in_workflow_approve PASSED [  1%]
tests/integration/test_approval_history_integration.py::test_approval_recording_in_workflow_reject PASSED [  2%]
tests/integration/test_approval_history_integration.py::test_approval_recording_in_workflow_change_folder PASSED [  2%]
tests/integration/test_approval_history_integration.py::test_statistics_api_endpoint PASSED [  2%]
tests/integration/test_approval_history_integration.py::test_database_index_performance PASSED [  2%]
tests/integration/test_approval_workflow_integration.py::TestApprovalWorkflowIntegration::test_complete_approve_workflow PASSED [  2%]
tests/integration/test_approval_workflow_integration.py::TestApprovalWorkflowIntegration::test_complete_reject_workflow PASSED [  2%]
tests/integration/test_approval_workflow_integration.py::TestApprovalWorkflowIntegration::test_complete_change_folder_workflow PASSED [  3%]
tests/integration/test_batch_notification_integration.py::test_complete_batch_notification_flow PASSED [  3%]
tests/integration/test_batch_notification_integration.py::test_priority_emails_bypass_batch PASSED [  3%]
tests/integration/test_batch_notification_integration.py::test_batch_with_no_pending_emails PASSED [  3%]
tests/integration/test_batch_notification_integration.py::test_celery_task_processes_all_users PASSED [  3%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_government_email_german PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_client_email_english PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_newsletter_email PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_unclear_email PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_russian_government_email PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_ukrainian_business_email PASSED [  4%]
tests/integration/test_classification_integration.py::TestClassificationWithGeminiAPI::test_classify_urgent_government_email_german PASSED [  5%]
tests/integration/test_classification_integration.py::TestEdgeCasesWithGeminiAPI::test_email_with_no_body PASSED [  5%]
tests/integration/test_classification_integration.py::TestEdgeCasesWithGeminiAPI::test_email_with_special_characters PASSED [  5%]
tests/integration/test_complete_system_e2e.py::TestCompleteSystemE2E::test_complete_email_to_response_workflow FAILED [  5%]
tests/integration/test_context_retrieval_integration.py::TestShortThreadAdaptiveK::test_retrieve_context_short_thread_adaptive_k PASSED [  5%]
tests/integration/test_context_retrieval_integration.py::TestStandardThreadHybridRAG::test_retrieve_context_standard_thread_hybrid_rag PASSED [  6%]
tests/integration/test_context_retrieval_integration.py::TestLongThreadSemanticSkip::test_retrieve_context_long_thread_skips_semantic PASSED [  6%]
tests/integration/test_context_retrieval_integration.py::TestTokenBudgetEnforcement::test_token_budget_enforcement_truncates_results PASSED [  6%]
tests/integration/test_context_retrieval_integration.py::TestPerformanceParallelRetrieval::test_retrieve_context_performance_parallel_retrieval PASSED [  6%]
tests/integration/test_email_polling_integration.py::test_email_polling_end_to_end PASSED [  6%]
tests/integration/test_email_polling_integration.py::test_email_polling_duplicate_detection PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_metadata_extraction PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_empty_inbox PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_mixed_new_and_duplicates PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_invalid_sender_email PASSED [  7%]
tests/integration/test_email_polling_integration.py::test_email_polling_workflow_integration PASSED [  7%]
tests/integration/test_email_workflow_integration.py::test_workflow_state_transitions PASSED [  8%]
tests/integration/test_email_workflow_integration.py::test_workflow_checkpoint_persistence PASSED [  8%]
tests/integration/test_email_workflow_integration.py::test_classification_result_stored_in_database PASSED [  8%]
tests/integration/test_email_workflow_integration.py::test_workflow_error_handling PASSED [  8%]
tests/integration/test_embedding_integration.py::TestEmbedAndStoreInChromaDB::test_embed_and_store_in_chromadb PASSED [  8%]
tests/integration/test_embedding_integration.py::TestBatchEmbeddingMultilingual::test_batch_embedding_multilingual_emails PASSED [  9%]
tests/integration/test_embedding_integration.py::TestBatchProcessingPerformance::test_batch_processing_performance_50_per_minute PASSED [  9%]
tests/integration/test_embedding_integration.py::TestIntegrationHelpers::test_vector_db_client_available PASSED [  9%]
tests/integration/test_embedding_integration.py::TestIntegrationHelpers::test_embedding_service_available PASSED [  9%]
tests/integration/test_epic_1_complete.py::test_epic_1_complete_workflow PASSED [  9%]
tests/integration/test_epic_2_workflow_integration.py::TestCompleteEmailWorkflow::test_complete_email_sorting_workflow PASSED [  9%]
tests/integration/test_epic_2_workflow_integration.py::TestRejectionAndFolderChange::test_email_rejection_workflow PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestRejectionAndFolderChange::test_folder_change_workflow PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestBatchNotificationSystem::test_batch_notification_workflow PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestBatchNotificationSystem::test_empty_batch_handling PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestPriorityEmailNotifications::test_priority_email_bypass_batch PASSED [ 10%]
tests/integration/test_epic_2_workflow_integration.py::TestPriorityEmailNotifications::test_priority_detection_government_domain PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestPriorityEmailNotifications::test_priority_detection_urgent_keywords PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestApprovalHistoryTracking::test_approval_history_rejection_recorded PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestApprovalHistoryTracking::test_approval_history_folder_change_recorded PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestApprovalHistoryTracking::test_approval_statistics_endpoint PASSED [ 11%]
tests/integration/test_epic_2_workflow_integration.py::TestPerformance::test_email_processing_latency_under_2_minutes PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestPerformance::test_workflow_resumption_latency_under_2_seconds PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestPerformance::test_batch_processing_performance_20_emails PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestErrorHandling::test_workflow_handles_gemini_api_failure PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestErrorHandling::test_workflow_handles_gmail_api_failure PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestErrorHandling::test_workflow_handles_telegram_api_failure PASSED [ 12%]
tests/integration/test_epic_2_workflow_integration.py::TestErrorHandling::test_workflow_checkpoint_recovery_after_crash PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration.py::TestWorkflowGraphStructure::test_workflow_has_generate_response_node PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration.py::TestWorkflowGraphStructure::test_workflow_conditional_routing_configured PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration.py::TestWorkflowGraphStructure::test_routing_logic_needs_response_path PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration.py::TestWorkflowGraphStructure::test_routing_logic_sort_only_path PASSED [ 13%]
tests/integration/test_epic_3_workflow_integration_e2e.py::TestConditionalWorkflowRouting::test_needs_response_workflow_path FAILED [ 14%]
tests/integration/test_epic_3_workflow_integration_e2e.py::TestConditionalWorkflowRouting::test_sort_only_workflow_path PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestRetryUtilityIntegration::test_retry_with_eventual_success PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestRetryUtilityIntegration::test_retry_exhaustion_raises_exception PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestGmailAPIErrorHandling::test_gmail_apply_label_with_retry PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestTelegramAPIErrorHandling::test_telegram_send_message_with_retry PASSED [ 14%]
tests/integration/test_error_handling_integration.py::TestTelegramAPIErrorHandling::test_telegram_send_message_user_blocked_no_retry PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestTelegramAPIErrorHandling::test_telegram_message_truncation PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestWorkflowNodeErrorHandling::test_execute_action_gmail_error_updates_status PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestManualRetryCommand::test_retry_command_resets_error_status PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestErrorStatisticsEndpoint::test_error_statistics_calculation PASSED [ 15%]
tests/integration/test_error_handling_integration.py::TestEndToEndErrorRecovery::test_complete_error_recovery_flow PASSED [ 16%]
tests/integration/test_error_handling_integration.py::TestAdminErrorsEndpoint::test_admin_errors_endpoint_with_valid_key PASSED [ 16%]
tests/integration/test_error_handling_integration.py::TestAdminErrorsEndpoint::test_admin_errors_endpoint_with_filters PASSED [ 16%]
tests/integration/test_error_handling_integration.py::TestAdminErrorsEndpoint::test_admin_endpoint_invalid_api_key PASSED [ 16%]
tests/integration/test_error_handling_integration.py::TestUserStatsEndpoint::test_error_statistics_date_range_filter PASSED [ 16%]
tests/integration/test_gemini_integration.py::TestGeminiAPIRealCall::test_gemini_api_real_call PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiAPIRealCall::test_gemini_api_json_mode_real PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiTestEndpoint::test_test_endpoint_integration_text_mode PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiTestEndpoint::test_test_endpoint_integration_json_mode PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiTestEndpoint::test_test_endpoint_requires_authentication PASSED [ 17%]
tests/integration/test_gemini_integration.py::TestGeminiTestEndpoint::test_test_endpoint_invalid_response_format PASSED [ 17%]
tests/integration/test_indexing_integration.py::test_indexing_progress_database_integration PASSED [ 18%]
tests/integration/test_indexing_integration.py::test_chromadb_embedding_storage_integration PASSED [ 18%]
tests/integration/test_indexing_integration.py::test_batch_processing_with_real_chromadb PASSED [ 18%]
tests/integration/test_indexing_integration.py::test_error_handling_with_database_rollback PASSED [ 18%]
tests/integration/test_indexing_integration.py::test_incremental_indexing_workflow PASSED [ 18%]
tests/integration/test_label_integration.py::test_label_creation_end_to_end PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_creation_duplicate_name PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_application_to_message PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_removal_from_message PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_list_all_labels PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_color_customization PASSED [ 19%]
tests/integration/test_label_integration.py::test_label_unique_constraint_per_user PASSED [ 20%]
tests/integration/test_language_detection_integration.py::test_detect_all_4_supported_languages PASSED [ 20%]
tests/integration/test_language_detection_integration.py::test_store_detected_language_in_email_queue PASSED [ 20%]
tests/integration/test_language_detection_integration.py::test_mixed_language_email_workflow PASSED [ 20%]
tests/integration/test_language_detection_integration.py::test_low_confidence_fallback_to_english PASSED [ 20%]
tests/integration/test_multilingual_response_quality.py::test_russian_business_inquiry_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_ukrainian_client_request_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_english_business_proposal_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_german_government_email_formal_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_mixed_language_email_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_no_thread_history_response PASSED [ 21%]
tests/integration/test_multilingual_response_quality.py::test_unclear_tone_detection PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_short_email_language_detection PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_very_long_thread_response PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_rag_context_retrieval_performance PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_response_generation_end_to_end_performance PASSED [ 22%]
tests/integration/test_multilingual_response_quality.py::test_complete_email_to_telegram_to_send_workflow PASSED [ 23%]
tests/integration/test_oauth_integration.py::test_oauth_flow_end_to_end PASSED [ 23%]
tests/integration/test_oauth_integration.py::test_oauth_token_refresh_on_401 PASSED [ 23%]
tests/integration/test_oauth_integration.py::test_oauth_state_validation_csrf_protection PASSED [ 23%]
tests/integration/test_oauth_integration.py::test_oauth_existing_user_token_update PASSED [ 23%]
tests/integration/test_priority_detection_integration.py::test_priority_email_immediate_notification PASSED [ 24%]
tests/integration/test_priority_detection_integration.py::test_non_priority_email_batched PASSED [ 24%]
tests/integration/test_priority_detection_integration.py::test_priority_email_excluded_from_batch PASSED [ 24%]
tests/integration/test_priority_detection_integration.py::test_user_configured_priority_sender_integration PASSED [ 24%]
tests/integration/test_prompt_generation_integration.py::test_formal_german_government_email_prompt PASSED [ 24%]
tests/integration/test_prompt_generation_integration.py::test_professional_english_business_email_prompt PASSED [ 24%]
tests/integration/test_prompt_generation_integration.py::test_casual_russian_personal_email_prompt PASSED [ 25%]
tests/integration/test_prompt_generation_integration.py::test_multilingual_prompt_quality PASSED [ 25%]
tests/integration/test_prompt_generation_integration.py::test_tone_detection_with_real_gemini PASSED [ 25%]
tests/integration/test_response_draft_telegram_integration.py::test_end_to_end_response_draft_notification_german PASSED [ 25%]
tests/integration/test_response_draft_telegram_integration.py::test_end_to_end_response_draft_notification_english PASSED [ 25%]
tests/integration/test_response_draft_telegram_integration.py::test_response_draft_long_message_splitting PASSED [ 26%]
tests/integration/test_response_draft_telegram_integration.py::test_response_draft_notification_with_rag_context PASSED [ 26%]
tests/integration/test_response_draft_telegram_integration.py::test_response_draft_notification_priority_email PASSED [ 26%]
tests/integration/test_response_draft_telegram_integration.py::test_telegram_user_not_linked_handling PASSED [ 26%]
tests/integration/test_response_editing_sending_integration.py::test_end_to_end_edit_workflow PASSED [ 26%]
tests/integration/test_response_editing_sending_integration.py::test_end_to_end_send_original_draft PASSED [ 26%]
tests/integration/test_response_editing_sending_integration.py::test_end_to_end_send_edited_draft PASSED [ 27%]
tests/integration/test_response_editing_sending_integration.py::test_email_threading_in_reply PASSED [ 27%]
tests/integration/test_response_editing_sending_integration.py::test_sent_response_indexed_to_chromadb PASSED [ 27%]
tests/integration/test_response_editing_sending_integration.py::test_reject_response_workflow PASSED [ 27%]
tests/integration/test_response_generation_integration.py::test_end_to_end_response_generation_german_formal PASSED [ 27%]
tests/integration/test_response_generation_integration.py::test_end_to_end_response_generation_english_professional PASSED [ 28%]
tests/integration/test_response_generation_integration.py::test_should_not_generate_response_newsletter PASSED [ 28%]
tests/integration/test_response_generation_integration.py::test_response_quality_validation_rejects_invalid PASSED [ 28%]
tests/integration/test_response_generation_integration.py::test_response_generation_with_short_thread PASSED [ 28%]
tests/integration/test_response_generation_integration.py::test_response_generation_with_real_gemini SKIPPED [ 28%]
tests/integration/test_telegram_bot_integration.py::TestBotStartupAndPolling::test_bot_startup_and_polling PASSED [ 29%]
tests/integration/test_telegram_bot_integration.py::TestTelegramTestEndpoint::test_send_test_message_endpoint_success PASSED [ 29%]
tests/integration/test_telegram_bot_integration.py::TestTelegramTestEndpoint::test_send_message_no_telegram_linked PASSED [ 29%]
tests/integration/test_telegram_bot_integration.py::TestTelegramTestEndpoint::test_send_message_user_blocked_bot PASSED [ 29%]
tests/integration/test_telegram_linking_integration.py::TestGenerateCodeEndpoint::test_generate_code_endpoint_success PASSED [ 29%]
tests/integration/test_telegram_linking_integration.py::TestGenerateCodeEndpoint::test_generate_code_already_linked PASSED [ 29%]
tests/integration/test_telegram_linking_integration.py::TestTelegramStatusEndpoint::test_telegram_status_not_linked PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestTelegramStatusEndpoint::test_telegram_status_linked PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_with_valid_code PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_with_expired_code PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_with_used_code PASSED [ 30%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_with_invalid_code PASSED [ 31%]
tests/integration/test_telegram_linking_integration.py::TestBotStartCommandLinking::test_bot_start_command_without_code PASSED [ 31%]
tests/integration/test_vector_db_integration.py::test_vector_db_persistence_survives_restart PASSED [ 31%]
tests/integration/test_vector_db_integration.py::test_semantic_search_returns_similar_embeddings PASSED [ 31%]
tests/integration/test_vector_db_integration.py::test_query_performance_k10_under_500ms PASSED [ 31%]
tests/integration/test_vector_db_integration.py::test_connection_test_endpoint PASSED [ 31%]
tests/test_approval_history.py::test_approval_history_model_creation PASSED [ 32%]
tests/test_approval_history.py::test_record_approve_decision PASSED      [ 32%]
tests/test_approval_history.py::test_record_reject_decision PASSED       [ 32%]
tests/test_approval_history.py::test_record_change_folder_decision PASSED [ 32%]
tests/test_approval_history.py::test_get_user_history_with_filters PASSED [ 32%]
tests/test_approval_history.py::test_get_approval_statistics_calculation PASSED [ 33%]
tests/test_batch_notification_service.py::test_get_pending_emails_filters_correctly PASSED [ 33%]
tests/test_batch_notification_service.py::test_create_summary_message_format PASSED [ 33%]
tests/test_batch_notification_service.py::test_empty_batch_handling PASSED [ 33%]
tests/test_batch_notification_service.py::test_quiet_hours_check PASSED  [ 33%]
tests/test_batch_notification_service.py::test_batch_disabled_user PASSED [ 34%]
tests/test_batch_notification_service.py::test_individual_proposals_rate_limiting PASSED [ 34%]
tests/test_batch_notification_service.py::test_get_user_preferences_creates_defaults PASSED [ 34%]
tests/test_classification_prompt.py::TestPromptConstruction::test_build_classification_prompt_structure PASSED [ 34%]
tests/test_classification_prompt.py::TestPromptConstruction::test_build_classification_prompt_with_html_body PASSED [ 34%]
tests/test_classification_prompt.py::TestPromptConstruction::test_build_classification_prompt_with_long_body PASSED [ 34%]
tests/test_classification_prompt.py::TestPromptConstruction::test_preprocess_email_body_html_stripping PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_preprocess_email_body_truncation PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_preprocess_email_body_empty PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_format_folder_categories_multiple PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_format_folder_categories_empty PASSED [ 35%]
tests/test_classification_prompt.py::TestPromptConstruction::test_build_classification_prompt_with_multiple_folder_categories PASSED [ 36%]
tests/test_classification_prompt.py::TestPromptConstruction::test_prompt_version_constant PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_valid_full PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_valid_required_only PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_missing_required_field PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_invalid_priority_score PASSED [ 36%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_invalid_confidence PASSED [ 37%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_reasoning_too_long PASSED [ 37%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_empty_folder PASSED [ 37%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_to_dict PASSED [ 37%]
tests/test_classification_prompt.py::TestClassificationResponseValidation::test_classification_response_edge_values PASSED [ 37%]
tests/test_classification_service.py::test_classify_email_success PASSED [ 38%]
tests/test_classification_service.py::test_classify_email_gemini_api_error PASSED [ 38%]
tests/test_classification_service.py::test_classify_email_invalid_json_response PASSED [ 38%]
tests/test_classification_service.py::test_classify_email_gmail_retrieval_failure PASSED [ 38%]
tests/test_context_retrieval.py::TestThreadHistoryRetrieval::test_get_thread_history_returns_last_5_emails PASSED [ 38%]
tests/test_context_retrieval.py::TestSemanticSearch::test_get_semantic_results_queries_vector_db PASSED [ 39%]
tests/test_context_retrieval.py::TestAdaptiveKLogic::test_calculate_adaptive_k_logic PASSED [ 39%]
tests/test_context_retrieval.py::TestResultRanking::test_rank_semantic_results_by_score_and_recency PASSED [ 39%]
tests/test_context_retrieval.py::TestTokenCounting::test_count_tokens_uses_tiktoken PASSED [ 39%]
tests/test_context_retrieval.py::TestTokenBudgetEnforcement::test_enforce_token_budget_truncates_correctly PASSED [ 39%]
tests/test_context_retrieval.py::TestContextRetrievalOrchestration::test_retrieve_context_combines_thread_and_semantic PASSED [ 39%]
tests/test_context_retrieval.py::TestPerformance::test_retrieve_context_performance_under_3_seconds PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_start_indexing_creates_progress_record PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_retrieve_gmail_emails_90_day_filter PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_process_batch_embeds_and_stores_50_emails PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_extract_metadata_includes_all_fields PASSED [ 40%]
tests/test_email_indexing.py::TestEmailIndexingService::test_resume_indexing_from_checkpoint PASSED [ 41%]
tests/test_email_indexing.py::TestEmailIndexingService::test_handle_error_updates_progress_status PASSED [ 41%]
tests/test_email_indexing.py::TestEmailIndexingService::test_mark_complete_updates_status PASSED [ 41%]
tests/test_email_indexing.py::TestEmailIndexingService::test_incremental_indexing_new_email PASSED [ 41%]
tests/test_email_integration.py::test_send_email_end_to_end PASSED       [ 41%]
tests/test_email_integration.py::test_send_email_with_thread_reply PASSED [ 41%]
tests/test_email_integration.py::test_send_email_html_body PASSED        [ 42%]
tests/test_email_integration.py::test_send_email_invalid_recipient PASSED [ 42%]
tests/test_email_integration.py::test_send_email_quota_exceeded PASSED   [ 42%]
tests/test_email_integration.py::test_send_email_message_too_large PASSED [ 42%]
tests/test_email_integration.py::test_send_email_invalid_body_type PASSED [ 42%]
tests/test_email_integration.py::test_send_email_unauthenticated PASSED  [ 43%]
tests/test_email_integration.py::test_send_email_logging PASSED          [ 43%]
tests/test_email_model.py::test_email_model_creation PASSED              [ 43%]
tests/test_email_model.py::test_email_user_relationship PASSED           [ 43%]
tests/test_email_model.py::test_unique_gmail_message_id PASSED           [ 43%]
tests/test_email_model.py::test_status_field_values PASSED               [ 43%]
tests/test_email_model.py::test_cascade_delete_emails PASSED             [ 44%]
tests/test_email_model.py::test_email_timestamps PASSED                  [ 44%]
tests/test_email_model.py::test_default_status_pending PASSED            [ 44%]
tests/test_email_polling.py::test_poll_user_emails_fetches_unread_emails PASSED [ 44%]
tests/test_email_polling.py::test_duplicate_detection_skips_existing_emails PASSED [ 44%]
tests/test_email_polling.py::test_poll_all_users_iterates_active_users PASSED [ 45%]
tests/test_email_polling.py::test_poll_all_users_skips_users_without_token PASSED [ 45%]
tests/test_email_polling.py::test_polling_error_handling_transient_errors PASSED [ 45%]
tests/test_email_polling.py::test_polling_error_handling_permanent_errors PASSED [ 45%]
tests/test_email_polling.py::test_get_active_users_filters_active PASSED [ 45%]
tests/test_email_polling.py::test_email_metadata_extraction PASSED       [ 46%]
tests/test_email_polling.py::test_polling_cycle_logging PASSED           [ 46%]
tests/test_email_polling.py::test_poll_user_emails_handles_empty_inbox PASSED [ 46%]
tests/test_email_polling.py::test_poll_user_emails_skips_invalid_email PASSED [ 46%]
tests/test_email_polling.py::test_poll_saves_new_emails_to_database PASSED [ 46%]
tests/test_email_polling.py::test_duplicate_detection_with_database_persistence PASSED [ 46%]
tests/test_email_polling.py::test_poll_mixed_new_and_duplicate_emails_db 