<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Database Setup for User Data</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-3-database-setup-for-user-data.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>to set up PostgreSQL database with initial schema for user management</iWant>
    <soThat>I can store user authentication tokens and settings</soThat>
    <tasks>
      <task id="1" acs="1,2">Set up PostgreSQL database instance</task>
      <task id="2" acs="3">Configure SQLAlchemy ORM in backend</task>
      <task id="3" acs="4">Create Users table model with SQLAlchemy</task>
      <task id="4" acs="5">Set up Alembic migrations framework</task>
      <task id="5" acs="6">Generate and apply initial database migration</task>
      <task id="6" acs="7">Create database health check endpoint</task>
      <task id="7" acs="all">Testing and verification</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">PostgreSQL database created (local development or free-tier cloud service like Supabase)</criterion>
    <criterion id="2">Database connection string configured in environment variables</criterion>
    <criterion id="3">SQLAlchemy ORM integrated into backend service</criterion>
    <criterion id="4">Initial database schema created with Users table (id, email, gmail_oauth_token, telegram_id, created_at, updated_at)</criterion>
    <criterion id="5">Database migrations framework set up (Alembic)</criterion>
    <criterion id="6">Initial migration successfully applied to database</criterion>
    <criterion id="7">Database connection test endpoint created (GET /db/health)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Database Models</section>
        <snippet>Lines 936-951: Complete Users table SQL schema with all fields (id, email, gmail_oauth_token, gmail_refresh_token, telegram_id, telegram_username, is_active, onboarding_completed, created_at, updated_at) and indexes on email and telegram_id.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Technology Stack - Database Layer</section>
        <snippet>Lines 234-238: PostgreSQL 18 as primary database, SQLAlchemy 2.x with async support, Alembic for migrations, ChromaDB for vector storage. LangGraph uses PostgreSQL checkpointing for workflow state persistence.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Data Relationships</section>
        <snippet>Lines 1047-1064: Users table is root entity with 1:N relationships to folder_categories, email_processing_queue, approval_history, notification_preferences, and 1:1 to workflow_mapping.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Data Models and Contracts</section>
        <snippet>Users table schema details including field types, constraints, and OAuth token encryption strategy (Fernet encryption in Story 1.4).</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-2-backend-service-foundation.md</path>
        <title>Story 1.2 - Backend Service Foundation</title>
        <section>Learnings</section>
        <snippet>Template provides database service at backend/app/services/database.py with async SQLAlchemy setup. Alembic likely pre-configured. Health endpoint pattern established.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/app/models/user.py</path>
        <kind>model</kind>
        <symbol>User</symbol>
        <lines>20-45</lines>
        <reason>Existing User model from template - needs modification to add Mail Agent specific fields (gmail_oauth_token, gmail_refresh_token, telegram_id, telegram_username, is_active, onboarding_completed)</reason>
      </artifact>
      <artifact>
        <path>backend/app/models/base.py</path>
        <kind>model</kind>
        <symbol>BaseModel</symbol>
        <lines>8-11</lines>
        <reason>Base model with created_at field - User model should extend this and add updated_at field</reason>
      </artifact>
      <artifact>
        <path>backend/app/models/database.py</path>
        <kind>service</kind>
        <symbol>__all__</symbol>
        <lines>1-5</lines>
        <reason>Database models registry - User model needs to be imported here for migration discovery</reason>
      </artifact>
      <artifact>
        <path>backend/docker-compose.yml</path>
        <kind>config</kind>
        <symbol>db service</symbol>
        <lines>4-21</lines>
        <reason>Existing PostgreSQL service using pgvector/pgvector:pg16 image - needs update to use postgres:18-alpine and database name to 'mailagent'</reason>
      </artifact>
      <artifact>
        <path>backend/pyproject.toml</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>11-41</lines>
        <reason>Dependencies include sqlmodel, psycopg2-binary, but missing Alembic - needs to be added</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="fastapi" version=">=0.115.12" />
        <package name="sqlmodel" version=">=0.0.24" />
        <package name="psycopg2-binary" version=">=2.9.10" />
        <package name="uvicorn" version=">=0.34.0" />
        <package name="pydantic" version=">=2.11.1" />
        <package name="pydantic-settings" version=">=2.8.1" />
        <package name="python-dotenv" version=">=1.1.0" />
        <package name="langgraph-checkpoint-postgres" version=">=2.0.19" />
        <package name="bcrypt" version=">=4.3.0" />
        <package name="structlog" version=">=25.2.0" />
        <package name="prometheus-client" version=">=0.19.0" />
        <package name="alembic" version="MISSING - needs to be added to pyproject.toml" />
      </python>
      <docker>
        <service name="PostgreSQL" image="pgvector/pgvector:pg16" note="Needs update to postgres:18-alpine per architecture" />
        <service name="Prometheus" image="prom/prometheus:latest" />
        <service name="Grafana" image="grafana/grafana:latest" />
      </docker>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use SQLModel (not pure SQLAlchemy) as it's already in template - extends from BaseModel class</constraint>
    <constraint>All tables MUST include created_at and updated_at timestamps with timezone awareness</constraint>
    <constraint>Use async session management patterns from template (async with get_db())</constraint>
    <constraint>Database name must be 'mailagent' (not template default)</constraint>
    <constraint>PostgreSQL 18 required (architecture specifies version 18)</constraint>
    <constraint>OAuth token fields (gmail_oauth_token, gmail_refresh_token) are TEXT type to accommodate encrypted strings (encryption happens in Story 1.4)</constraint>
    <constraint>Indexes required on email (unique) and telegram_id (unique when not null)</constraint>
    <constraint>All schema changes MUST go through Alembic migrations - no direct database modifications</constraint>
    <constraint>Environment variables for database credentials - never hardcode in code</constraint>
    <constraint>Health check endpoint must return 200 OK when connected, 503 on failure</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>GET /health/db</name>
      <kind>REST endpoint</kind>
      <signature>GET /health/db â†’ {status: string, database?: string, message?: string, error?: string}</signature>
      <path>backend/app/api/v1/health.py (to be created)</path>
    </interface>
    <interface>
      <name>User Model</name>
      <kind>SQLModel class</kind>
      <signature>class User(BaseModel, table=True) with fields: id, email, gmail_oauth_token, gmail_refresh_token, telegram_id, telegram_username, is_active, onboarding_completed, created_at, updated_at</signature>
      <path>backend/app/models/user.py</path>
    </interface>
    <interface>
      <name>Database Session</name>
      <kind>async context manager</kind>
      <signature>async with get_db() as session: await session.execute(statement)</signature>
      <path>backend/app/services/database.py (likely exists in template)</path>
    </interface>
    <interface>
      <name>Alembic Commands</name>
      <kind>CLI</kind>
      <signature>alembic revision --autogenerate -m "message", alembic upgrade head, alembic downgrade -1</signature>
      <path>backend/ (run from backend directory)</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Testing framework: pytest (>=8.3.5) configured in pyproject.toml. Test files follow naming convention: test_*.py or *_test.py. No tests directory exists yet - needs to be created. For database infrastructure setup stories, manual testing via psql and curl is primary verification method. Automated unit tests are optional but recommended for practice. Story notes indicate "No Automated Tests Required" for this infrastructure story, but integration tests will begin in Story 1.4+.</standards>
    <locations>
      <location>backend/tests/ (to be created)</location>
      <location>Test files: test_*.py, *_test.py</location>
      <location>Manual testing: psql commands, curl for health endpoint</location>
    </locations>
    <ideas>
      <idea ac="1,2">Manual test: PostgreSQL container starts successfully (docker ps, docker logs)</idea>
      <idea ac="2">Manual test: Can connect via psql using DATABASE_URL credentials</idea>
      <idea ac="3,4">Manual test: Users table exists with correct schema (\dt, \d users in psql)</idea>
      <idea ac="5,6">Manual test: Alembic tracks migration (alembic current shows hash)</idea>
      <idea ac="7">Manual test: Health endpoint returns {"status": "connected"} (curl http://localhost:8000/health/db)</idea>
      <idea ac="4">Optional unit test: Test User model creation with all fields</idea>
      <idea ac="4">Optional unit test: Test unique constraints (duplicate email should fail)</idea>
      <idea ac="4">Optional unit test: Test timestamps auto-populate on creation</idea>
    </ideas>
  </tests>
</story-context>
